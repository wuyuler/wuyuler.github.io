# 云原生

云原生数据库有两种常见的架构：共享存储架构（shared-storage）和无共享架构（shared-nothing ）。

# 无共享架构

## 定义

一般架构图如下：

![image-20210125210139635](https://gitee.com/yyjjtt/picture_bed/raw/master/img/20210125210209.png)

所谓“⽆共享”，是指每个节点都是独⽴的进程，彼此不共享资源，⽽是通过**⽹络 RPC** 的⽅式进⾏通讯和数据交换。

我们常说的“Sharding”就是Share Nothing架构，它把表从物理存储水平分割，并分配给多台服务器，每台服务器可以独立工作，具备相同的schema，只需要增加服务器数就可以增加处理能力和容量

Shared Nothing系统通常需要将它的数据分布到多个节点的不同数据库（不同计算机处理不同的用户和查询）或者要求每个结点通过使用某些协调协议来保留它自己的应用程序数据备份，这通常被称为数据库的**Sharding**

## 无共享架构优势

1. 无共享存储对拓展性更加友好，无论计算层还是存储层都能通过增加节点的方式提升处理能力
2. 通过增加廉价的计算机作为系统节点却可以获取几乎无限的扩展

## 无共享架构缺陷

1. 每个结点都是独立进程，新加入的存储节点需要较长时间同步数据，其弹性相比共享存储架构略逊一筹
2. 如果要访问所有数据，必须所有节点可用

## 案例

比较典型的就是Google Spanner，其利用原子钟技术能够实现跨数据中心的数据一致性和事务一致性。

DB2 DPF和Hadoop，各节点相互独立，各自处理自己的数据，处理后的结果可能向上层汇总或在节点间流转

# 共享存储

## 定义

架构图

![image-20210125210146363](https://gitee.com/yyjjtt/picture_bed/raw/master/img/20210125210204.png)

 

共享存储即shared-storage，如果实现多写多读也就是实现了有时被称为shared-everything

共享存储架构简单的说就是将本地盘存储换成了分布式共享存储。通过RDMA这样的快速网络让上层的数据库内核看起来像是在使用本地磁盘，但实际上是分布式存储。

上面可以有多个计算结点，多写多读，或是一写多读。

## 共享存储的优势

1. 共享存储很好的解决了数据库存储容量的scale-out，几乎可以无限拓展。
2. 云厂商可以将磁盘资源池化，实现按实际使用量付费（pay-as-you-go），降低用户使用成本。
3. 只要有一个节点可用，就可以访问所有数据

## 共享存储的缺陷

不同表述，可以是同一个意思

1. 分布式的共享存储达到一定的结点数量后，性能会出现一定的损耗，不能保证访问远程数据和访问本地数据的性能完全相同，所以一般拓展到十几个结点就达到**scale out的拓展上限**了
2. 共享架构存在明显的性能瓶颈：尽管存储方面全面的拥抱了分布式，但计算层（包括事务管理，查询处理等模块）还保留单机数据库的结构，并发事务处理能力（写入吞吐量）收到单个结点性能的制约（这里考虑的是一写多读架构）
3. 内存融合（cache fusion）大大限制了它的水平拓展能力。

## share-cache

> Oracle RAC采用的是share-disk结构,所有节点连接到一个磁盘阵列上。每个节点都能够访问所有数据。但是RAC在数据的并发访问上，采用了比传统的share-disk更先进的技术：传统的share-disk结构，两个节点要同时修改一份数据时，需要利用磁盘IO来进行同步，而RAC中采用了Cache Fusion技术，这是一种是一种保证各节点数据缓存的一技术，当要修改某个数据块时，不是直接从磁盘中取取得数据块，而是通过网络从其他节点的数据缓冲区中获取，通过一定的加锁机制，就能够保证数据的一致性。这种技术，避免了需要通过磁盘IO来进行数据同步，提高了系统的效率。

[shared-nothing VS shared-disk - 简书](https://www.jianshu.com/p/04c8c9d06d14)

> 1. 内存融合是实现多节点对数据并发访问和修改的一种机制
> 2. ▸ Cache Fusion的要点
>    1、⾼速私有⽹络
>    2、共享存储
>    3、节点间的访问机制 --通过这三个特点实现了内存融合

[(2条消息) RAC Cache Fusion 内存融合详解_小楼一夜听春雨，深巷明朝卖杏花-CSDN博客](https://blog.csdn.net/qq_34556414/article/details/81515754)

## 案例

共享存储架构以Amazon Aurora, 阿里云PolarDB为代表。

# 混合架构

Shared Nothing 和 Shared Storage可以结合形成混合（Hybrid）架构。

可以在上层做Shared Nothing，而对于下层的Shard分片采用Share Storage架构。

![img](https://gitee.com/yyjjtt/picture_bed/raw/master/img/20210126143145.jpeg)

结合两种架构的优势，向shared nothing架构一样具有接近无限的scale out能力，不受单个读写结点的限制

另一方面，利用容器技术以及云存储的优势，做到随时扩容缩容，用户只需要为实际使用的资源付费。

## 优势

1. 减轻分出太多Shard的痛点问题，进而减轻分布式事务distributed commit的概率，distributed commit的代价非常昂贵。